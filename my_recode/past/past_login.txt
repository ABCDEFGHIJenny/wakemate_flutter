import 'package:flutter/material.dart';
import 'package:http/http.dart' as http;
import 'dart:convert';
import 'home_page.dart';

//è¦†å¯«äº†çˆ¶é¡åˆ¥çš„æ–¹æ³•ï¼Œä¸¦å‰µå»ºäº†èˆ‡ LoginPage ç›¸é—œè¯çš„ç‹€æ…‹é¡åˆ¥ _LoginPageState
class LoginPage extends StatefulWidget {
  const LoginPage({super.key});
  @override
  State<LoginPage> createState() => _LoginPageState();
}

//é–‹é ­çš„åº•ç·š _ åœ¨ Dart èªè¨€ä¸­ä»£è¡¨é€™å€‹é¡åˆ¥æ˜¯ç§æœ‰çš„ (private)
//extends ä»£è¡¨é€™å€‹é¡åˆ¥ç¹¼æ‰¿è‡ªå¦ä¸€å€‹é¡åˆ¥
//State<LoginPage> æ˜¯ Flutter æä¾›çš„ä¸€å€‹æ³›å‹é¡åˆ¥ (generic class)
//å®ƒå‘Šè¨´ç·¨è­¯å™¨ï¼Œ_LoginPageState é€™å€‹ç‹€æ…‹é¡åˆ¥æ˜¯å°ˆé–€ç‚º LoginPage é€™å€‹ StatefulWidget æœå‹™çš„
class _LoginPageState extends State<LoginPage> {
  //final ä»£è¡¨é€™å€‹è®Šæ•¸åªèƒ½è¢«è³¦å€¼ä¸€æ¬¡
  final emailInput = TextEditingController();
  final passwordInput = TextEditingController();
  final nameInput = TextEditingController();

  final String baseUrl = 'https://wakemate-api-4-0.onrender.com';
  bool isLoading = false;

  //è¨»å†Šä½¿ç”¨è€…ï¼ŒéåŒæ­¥å‡½æ•¸å®£å‘Šã€‚
  //Future<void>
  //ä»£è¡¨ä¸€å€‹å°šæœªå®Œæˆçš„æ“ä½œã€‚å®ƒè¡¨ç¤ºé€™å€‹å‡½æ•¸ä¸æœƒç«‹å³è¿”å›çµæœï¼Œè€Œæ˜¯æœƒåœ¨æœªä¾†æŸå€‹æ™‚é–“é»å®Œæˆä¸¦è¿”å›
  //<void>ï¼šé€™æ˜¯ä¸€å€‹æ³›å‹ï¼Œå®ƒå‘Šè¨´æˆ‘å€‘ç•¶é€™å€‹ Future å®Œæˆæ™‚ï¼Œå®ƒä¸æœƒè¿”å›ä»»ä½•æœ‰ç”¨çš„å€¼
  Future<void> _registerUser() async {
    //.text:å–å¾—æ–‡å­—è¼¸å…¥æ¡†ä¸­çš„å…§å®¹ï¼Œä»¥å­—ä¸²çš„å½¢å¼å›å‚³
    //.trim():ç§»é™¤å­—ä¸²é–‹é ­å’Œçµå°¾çš„æ‰€æœ‰ç©ºç™½å­—å…ƒï¼Œä¾‹å¦‚ç©ºæ ¼ã€æ›è¡Œç¬¦è™Ÿæˆ– Tab éµã€‚
    final email = emailInput.text.trim();
    final password = passwordInput.text.trim();
    final name = nameInput.text.trim();

    if (email.isEmpty || password.isEmpty || name.isEmpty) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: const Text(
            "è«‹è¼¸å…¥ Emailã€å¯†ç¢¼èˆ‡åå­—",
            style: TextStyle(color: Colors.white),
          ),
          backgroundColor: const Color.fromARGB(255, 239, 100, 91), // æ”¹è®ŠèƒŒæ™¯è‰²
          behavior: SnackBarBehavior.floating, // æ‡¸æµ®é¡¯ç¤º
          shape: RoundedRectangleBorder(
            borderRadius: BorderRadius.circular(10), //åœ“è§’
          ),
          margin: const EdgeInsets.symmetric(horizontal: 16, vertical: 10),
        ),
      );
    }

    setState(() => isLoading = true);

    try {
      //Content-Type é€™æ˜¯ä¸€å€‹æ¨™æº–çš„ HTTP æ¨™é ­ï¼Œç”¨ä¾†å‘Šè¨´ä¼ºæœå™¨ä½ æ­£åœ¨ç™¼é€ä»€éº¼é¡å‹çš„è³‡æ–™
      //application/json: é€™å€‹å€¼è¡¨ç¤ºä½ ç™¼é€çš„è³‡æ–™æ˜¯ JSON æ ¼å¼ã€‚
      final headers = {'Content-Type': 'application/json'};
      final body = jsonEncode({
        "email": email,
        "password": password,
        "name": name,
        "created_at": DateTime.now().toIso8601String(),
      });

      final res = await http.post(
        //å°‡å­—ä¸²è½‰æ›æˆ Uri ç‰©ä»¶ï¼Œé€™æ˜¯ http.post å‡½æ•¸æ‰€éœ€è¦çš„æ ¼å¼ã€‚
        Uri.parse('$baseUrl/users/'),
        headers: headers,
        body: body,
      );

      //é™¤éŒ¯(å¯åˆªé™¤)
      print('ğŸ”¹ Response body: ${res.body}'); // Console Debug

      //æª¢æŸ¥ StatefulWidget æ˜¯å¦ä»åœ¨ç•«é¢ä¸Š
      if (!mounted) return;

      //é™¤éŒ¯(å¯åˆªé™¤)
      showDialog(
        context: context,
        builder:
            (_) => AlertDialog(
              title: const Text("ä¼ºæœå™¨å›æ‡‰"),
              content: Text(res.body),
              actions: [
                TextButton(
                  onPressed: () => Navigator.pop(context),
                  child: const Text("OK"),
                ),
              ],
            ),
      );

      if (res.statusCode == 200 || res.statusCode == 201) {
        final data = jsonDecode(res.body);

        //æŒ‰ç…§å„ªå…ˆé †åºå°‹æ‰¾ä½¿ç”¨è€… ID
        final String? uuidFromServer =
            data['user_id']?.toString() ?? data['id']?.toString();

        if (uuidFromServer != null && uuidFromServer.isNotEmpty) {
          Navigator.pushReplacement(
            context,
            MaterialPageRoute(
              builder:
                  (context) => HomePage(userId: uuidFromServer, email: email),
            ),
          );
        }
      } else {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(content: Text("âŒ å„²å­˜å¤±æ•—ï¼š${res.statusCode} ${res.body}")),
        );
      }
    } catch (e) {
      ScaffoldMessenger.of(
        context,
      ).showSnackBar(SnackBar(content: Text("éŒ¯èª¤ï¼š$e")));
    } finally {
      setState(() => isLoading = false);
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: const Text("è¨»å†Šä½¿ç”¨è€…")),
      body: Padding(
        padding: const EdgeInsets.all(16.0),
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            TextField(
              controller: nameInput,
              decoration: const InputDecoration(labelText: "åç¨±"),
            ),
            const SizedBox(height: 12),
            TextField(
              controller: emailInput,
              decoration: const InputDecoration(labelText: "Email"),
              keyboardType: TextInputType.emailAddress,
            ),
            const SizedBox(height: 12),
            TextField(
              controller: passwordInput,
              decoration: const InputDecoration(labelText: "å¯†ç¢¼"),
              obscureText: true,
            ),
            const SizedBox(height: 24),
            ElevatedButton(
              onPressed: isLoading ? null : _registerUser,
              child: Text(isLoading ? "è™•ç†ä¸­..." : "å„²å­˜ä½¿ç”¨è€…è³‡æ–™"),
            ),
          ],
        ),
      ),
    );
  }
}
